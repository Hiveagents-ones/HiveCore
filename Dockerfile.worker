# HiveCore Celery Worker Dockerfile
FROM python:3.12-slim

# Set environment variables
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV DJANGO_SETTINGS_MODULE=backend.settings
ENV C_FORCE_ROOT=1

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    libpq-dev \
    git \
    && rm -rf /var/lib/apt/lists/*

# Create app directory
WORKDIR /app

# Copy and install AgentScope (HiveCore) first
# This layer is cached if agentscope doesn't change
COPY agentscope /app/agentscope
RUN pip install --no-cache-dir -e /app/agentscope[full]

# Install backend dependencies
COPY backend/requirements.txt /app/backend/
RUN pip install --no-cache-dir -r /app/backend/requirements.txt

# Copy backend code
COPY backend /app/backend

# Create non-root user
RUN useradd -m -u 1000 appuser && chown -R appuser:appuser /app
USER appuser

# Create workspace directory
RUN mkdir -p /app/workspace

# Health check - Celery inspect ping
HEALTHCHECK --interval=60s --timeout=30s --start-period=10s --retries=3 \
    CMD celery -A backend inspect ping -d celery@$HOSTNAME || exit 1

# Run Celery worker
# --concurrency: 并发数
# --max-tasks-per-child: 每个子进程处理N个任务后重启（防止内存泄漏）
# --max-memory-per-child: 内存限制（KB）
CMD ["celery", "-A", "backend", "worker", \
     "--loglevel=INFO", \
     "--concurrency=2", \
     "--max-tasks-per-child=10", \
     "--max-memory-per-child=500000", \
     "-Q", "default,tenant.business,tenant.team,tenant.free"]
